/**
 * ×× ×”×œ ×ª×•×›×Ÿ ××™×©×™ - ×ª×”×™×œ×™× ×‘×§×“×•×©×”
 * 
 * ××¢×¨×›×ª ×–×• ×××¤×©×¨×ª ×œ××©×ª××©×™× ×œ×™×¦×•×¨, ×œ×¢×¨×•×š ×•×œ×©××•×¨ ×××¨×–×™× ××•×ª×××™× ××™×©×™×ª 
 * ×©×œ ×˜×§×¡×˜×™× ××ª×•×§× ×™×, ×•×œ×”×“×¤×™×¡ ××•×ª× ×‘×¤×•×¨××˜×™× ×©×•× ×™×.
 */

// ============================================
// ××•×“×œ × ×ª×•× ×™× ×œ×××¨×–×™× ××™×©×™×™×
// ============================================

/**
 * ××—×œ×§×” ×”××™×™×¦×’×ª ×××¨×– ×ª×•×›×Ÿ ××™×©×™
 */
class PersonalCollection {
  constructor(id, userId, title, type, items = [], metadata = {}) {
    this.id = id;                // ××–×”×” ×™×™×—×•×“×™
    this.userId = userId;        // ××©×ª××© ×‘×¢×œ ×”×××¨×–
    this.title = title;          // ×›×•×ª×¨×ª ×”×××¨×–
    this.type = type;            // ×¡×•×’ (×ª×”×™×œ×™×, ×ª×¤×™×œ×•×ª, ××¢×•×¨×‘)
    this.items = items;          // ×¤×¨×™×˜×™× ×‘×××¨×–
    this.metadata = metadata;    // ××™×“×¢ × ×•×¡×£ (×ª××¨×™×š ×™×¦×™×¨×”, ×ª×™××•×¨, ×ª×’×™×•×ª)
    this.lastModified = new Date(); // ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ
  }
  
  /**
   * ×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×××¨×–
   * @param {CollectionItem} item - ×”×¤×¨×™×˜ ×œ×”×•×¡×¤×”
   */
  addItem(item) {
    this.items.push(item);
    this.lastModified = new Date();
  }
  
  /**
   * ×”×¡×¨×ª ×¤×¨×™×˜ ××”×××¨×–
   * @param {string} itemId - ××–×”×” ×”×¤×¨×™×˜ ×œ×”×¡×¨×”
   */
  removeItem(itemId) {
    this.items = this.items.filter(item => item.id !== itemId);
    this.lastModified = new Date();
  }
  
  /**
   * ×¢×“×›×•×Ÿ ×¡×“×¨ ×”×¤×¨×™×˜×™×
   * @param {Array} newOrder - ××¢×¨×š ××–×”×™× ×‘×¡×“×¨ ×”×—×“×©
   */
  reorderItems(newOrder) {
    const itemMap = {};
    this.items.forEach(item => {
      itemMap[item.id] = item;
    });
    
    // ×¡×™×“×•×¨ ××—×“×© ×œ×¤×™ ×”×¡×“×¨ ×”×—×“×©
    this.items = newOrder.map(id => itemMap[id]);
    this.lastModified = new Date();
  }
}

/**
 * ××—×œ×§×” ×”××™×™×¦×’×ª ×¤×¨×™×˜ ×‘×××¨×–
 */
class CollectionItem {
  constructor(id, type, content, metadata = {}) {
    this.id = id;                // ××–×”×” ×™×™×—×•×“×™
    this.type = type;            // ×¡×•×’ (×¤×¨×§ ×ª×”×™×œ×™×, ×ª×¤×™×œ×”, ×˜×§×¡×˜ ××ª×•×§×Ÿ)
    this.content = content;      // ×ª×•×›×Ÿ ×”×¤×¨×™×˜
    this.metadata = metadata;    // ××™×“×¢ × ×•×¡×£ (××§×•×¨, ×ª××¨×™×š ×”×•×¡×¤×”, ×”×¢×¨×•×ª)
    this.userEdits = [];         // ×¢×¨×™×›×•×ª ××™×©×™×•×ª ×©×”××©×ª××© ×‘×™×¦×¢
  }
  
  /**
   * ×”×•×¡×¤×ª ×¢×¨×™×›×” ××™×©×™×ª ×œ×¤×¨×™×˜
   * @param {Edit} edit - ×”×¢×¨×™×›×” ×œ×”×•×¡×¤×”
   */
  addEdit(edit) {
    this.userEdits.push(edit);
  }
  
  /**
   * ×§×‘×œ×ª ×”×’×¨×¡×” ×”××¢×•×“×›× ×ª ×¢× ×›×œ ×”×¢×¨×™×›×•×ª
   * @returns {string} ×”×ª×•×›×Ÿ ×”××¢×•×“×›×Ÿ
   */
  getEditedContent() {
    let editedContent = this.content;
    
    // ×”×—×œ×ª ×›×œ ×”×¢×¨×™×›×•×ª
    this.userEdits.forEach(edit => {
      editedContent = edit.applyToContent(editedContent);
    });
    
    return editedContent;
  }
}

/**
 * ××—×œ×§×” ×”××™×™×¦×’×ª ×¢×¨×™×›×” (×œ××©×œ ×ª×™×§×•×Ÿ ×©× ×”')
 */
class Edit {
  constructor(id, type, replacementStyle, positions = []) {
    this.id = id;                  // ××–×”×” ×™×™×—×•×“×™
    this.type = type;              // ×¡×•×’ ×”×¢×¨×™×›×” (×ª×™×§×•×Ÿ ×©×, ×”×•×¡×¤×ª × ×™×§×•×“)
    this.replacementStyle = replacementStyle; // ×¡×’× ×•×Ÿ ×”×”×—×œ×¤×” (×”', ×™-×”-×•-×” ×•×›×•')
    this.positions = positions;    // ××™×§×•××™× ×œ×ª×™×§×•×Ÿ
    this.timestamp = new Date();   // ×–××Ÿ ×”×¢×¨×™×›×”
  }
  
  /**
   * ×”×—×œ×ª ×”×¢×¨×™×›×” ×¢×œ ×ª×•×›×Ÿ
   * @param {string} content - ×”×ª×•×›×Ÿ ×”××§×•×¨×™
   * @returns {string} ×”×ª×•×›×Ÿ ×”××¢×•×“×›×Ÿ
   */
  applyToContent(content) {
    // ×ª×™×§×•×Ÿ ×©× ×”'
    if (this.type === 'divine-name') {
      let editedContent = content;
      
      // ××™×•×Ÿ ×”××™×§×•××™× ××”×¡×•×£ ×œ×”×ª×—×œ×” ×›×“×™ ×©×œ× ×œ×”×©×¤×™×¢ ×¢×œ ××™× ×“×§×¡×™×
      const sortedPositions = [...this.positions].sort((a, b) => b.start - a.start);
      
      sortedPositions.forEach(pos => {
        const replacement = `<span class="divine-name">${this.replacementStyle}</span>`;
        editedContent = editedContent.substring(0, pos.start) +
                        replacement +
                        editedContent.substring(pos.end);
      });
      
      return editedContent;
    }
    
    // ×¡×•×’×™ ×¢×¨×™×›×” × ×•×¡×¤×™×...
    
    return content;
  }
}

// ============================================
// ×× ×”×œ ×××¨×–×™× ××™×©×™×™×
// ============================================

/**
 * ××—×œ×§×” ×œ× ×™×”×•×œ ×××¨×–×™× ××™×©×™×™×
 */
class PersonalContentManager {
  constructor(dataService) {
    this.dataService = dataService;
    this.collections = {};  // ××˜××•×Ÿ ×©×œ ×××¨×–×™× ×œ×¤×™ ××–×”×”
  }
  
  /**
   * ×™×¦×™×¨×ª ×××¨×– ×—×“×©
   * @param {string} userId - ××–×”×” ×”××©×ª××©
   * @param {string} title - ×›×•×ª×¨×ª ×”×××¨×–
   * @param {string} type - ×¡×•×’ ×”×××¨×–
   * @returns {Promise<PersonalCollection>} ×”×××¨×– ×”×—×“×©
   */
  async createCollection(userId, title, type) {
    try {
      const collection = new PersonalCollection(
        generateUUID(),  // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ××–×”×” ×™×™×—×•×“×™
        userId,
        title,
        type,
        [],  // ×¤×¨×™×˜×™× ×¨×™×§ ×‘×”×ª×—×œ×”
        {
          createdAt: new Date(),
          description: '',
          tags: []
        }
      );
      
      // ×©××™×¨×” ×‘××¡×“ ×”× ×ª×•× ×™×
      await this.dataService.saveCollection(collection);
      
      // ×©××™×¨×” ×‘××˜××•×Ÿ
      this.collections[collection.id] = collection;
      
      return collection;
    } catch (error) {
      console.error('Error creating collection:', error);
      throw new Error('Failed to create personal collection');
    }
  }
  
  /**
   * ×˜×¢×™× ×ª ×××¨×– ×œ×¤×™ ××–×”×”
   * @param {string} collectionId - ××–×”×” ×”×××¨×–
   * @returns {Promise<PersonalCollection>} ×”×××¨×– ×”××‘×•×§×©
   */
  async loadCollection(collectionId) {
    // ×‘×“×™×§×” ×× ×”×××¨×– ×›×‘×¨ ×‘××˜××•×Ÿ
    if (this.collections[collectionId]) {
      return this.collections[collectionId];
    }
    
    try {
      // ×˜×¢×™× ×” ××”×©×¨×ª
      const collection = await this.dataService.getCollection(collectionId);
      
      // ×©××™×¨×” ×‘××˜××•×Ÿ
      this.collections[collectionId] = collection;
      
      return collection;
    } catch (error) {
      console.error(`Error loading collection ${collectionId}:`, error);
      throw new Error('Failed to load collection');
    }
  }
  
  /**
   * ×˜×¢×™× ×ª ×›×œ ×”×××¨×–×™× ×©×œ ××©×ª××©
   * @param {string} userId - ××–×”×” ×”××©×ª××©
   * @returns {Promise<Array<PersonalCollection>>} ××¢×¨×š ×”×××¨×–×™×
   */
  async getUserCollections(userId) {
    try {
      const collections = await this.dataService.getUserCollections(userId);
      
      // ×©××™×¨×” ×‘××˜××•×Ÿ
      collections.forEach(collection => {
        this.collections[collection.id] = collection;
      });
      
      return collections;
    } catch (error) {
      console.error(`Error loading collections for user ${userId}:`, error);
      throw new Error('Failed to load user collections');
    }
  }
  
  /**
   * ×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×××¨×–
   * @param {string} collectionId - ××–×”×” ×”×××¨×–
   * @param {string} itemType - ×¡×•×’ ×”×¤×¨×™×˜
   * @param {Object} content - ×ª×•×›×Ÿ ×”×¤×¨×™×˜
   * @param {Object} metadata - ××™×“×¢ × ×•×¡×£
   * @returns {Promise<CollectionItem>} ×”×¤×¨×™×˜ ×©× ×•×¡×£
   */
  async addItemToCollection(collectionId, itemType, content, metadata = {}) {
    try {
      const collection = await this.loadCollection(collectionId);
      
      const item = new CollectionItem(
        generateUUID(),
        itemType,
        content,
        {
          ...metadata,
          addedAt: new Date()
        }
      );
      
      collection.addItem(item);
      
      // ×©××™×¨×ª ×”×©×™× ×•×™×™×
      await this.dataService.updateCollection(collection);
      
      return item;
    } catch (error) {
      console.error(`Error adding item to collection ${collectionId}:`, error);
      throw new Error('Failed to add item to collection');
    }
  }
  
  /**
   * ×¢×¨×™×›×ª ×¤×¨×™×˜ ×‘×××¨×–
   * @param {string} collectionId - ××–×”×” ×”×××¨×–
   * @param {string} itemId - ××–×”×” ×”×¤×¨×™×˜
   * @param {string} editType - ×¡×•×’ ×”×¢×¨×™×›×”
   * @param {string} replacementStyle - ×¡×’× ×•×Ÿ ×”×”×—×œ×¤×”
   * @param {Array} positions - ××™×§×•××™× ×œ×¢×¨×™×›×”
   * @returns {Promise<Edit>} ×”×¢×¨×™×›×” ×©× ×•×¡×¤×”
   */
  async editCollectionItem(collectionId, itemId, editType, replacementStyle, positions) {
    try {
      const collection = await this.loadCollection(collectionId);
      const item = collection.items.find(i => i.id === itemId);
      
      if (!item) {
        throw new Error(`Item ${itemId} not found in collection ${collectionId}`);
      }
      
      const edit = new Edit(
        generateUUID(),
        editType,
        replacementStyle,
        positions
      );
      
      item.addEdit(edit);
      
      // ×©××™×¨×ª ×”×©×™× ×•×™×™×
      await this.dataService.updateCollection(collection);
      
      return edit;
    } catch (error) {
      console.error(`Error editing item ${itemId} in collection ${collectionId}:`, error);
      throw new Error('Failed to edit collection item');
    }
  }
}

// ============================================
// ××¢×¨×›×ª ×”×“×¤×¡×” ××ª×§×“××ª
// ============================================

/**
 * ××—×œ×§×” ×œ× ×™×”×•×œ ×”×“×¤×¡×ª ×××¨×–×™×
 */
class PrintManager {
  constructor() {
    // ×”×’×“×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ
    this.defaultSettings = {
      format: 'A5',              // ×’×•×“×œ ×“×£
      fontSizeHebrew: 16,        // ×’×•×“×œ ×’×•×¤×Ÿ ×¢×‘×¨×™×ª
      fontSizeRussian: 14,       // ×’×•×“×œ ×’×•×¤×Ÿ ×¨×•×¡×™×ª
      showNikkud: true,          // ×”×¦×’×ª × ×™×§×•×“
      divineNameStyle: '×”\'',    // ×¡×’× ×•×Ÿ ×©× ×”'
      showBothLanguages: true,   // ×”×¦×’×ª ×©×ª×™ ×”×©×¤×•×ª
      margins: {                 // ×©×•×œ×™×™×
        top: 15,
        right: 15,
        bottom: 15,
        left: 15
      },
      addCover: true,            // ×”×•×¡×¤×ª ×¢××•×“ ×©×¢×¨
      addDedication: false,      // ×”×•×¡×¤×ª ×”×§×“×©×”
      dedicationText: ''         // ×˜×§×¡×˜ ×”×§×“×©×”
    };
  }
  
  /**
   * ×™×¦×™×¨×ª ××¡××š PDF ××××¨×–
   * @param {PersonalCollection} collection - ×”×××¨×– ×œ×”×“×¤×¡×”
   * @param {Object} settings - ×”×’×“×¨×•×ª ×”×“×¤×¡×”
   * @returns {Promise<Blob>} ×”×§×•×‘×¥ ×©× ×•×¦×¨
   */
  async generatePDF(collection, settings = {}) {
    // ×©×™×œ×•×‘ ×”×’×“×¨×•×ª ×‘×¨×™×¨×ª ×”××—×“×œ ×¢× ×”×”×’×“×¨×•×ª ×©×”×ª×§×‘×œ×•
    const printSettings = {
      ...this.defaultSettings,
      ...settings
    };
    
    try {
      // ×›××Ÿ × ×©×ª××© ×‘×¡×¤×¨×™×™×ª ×”×“×¤×¡×ª PDF (×›××• jsPDF ××• pdfmake)
      // ×œ×“×•×’××” ×‘×¡×™×¡×™×ª ×‘×œ×‘×“, × ×©×ª××© ×‘×ª×™××•×¨ ×¤×•× ×§×¦×™×•× ×œ×™×•×ª
      
      // ×™×¦×™×¨×ª ××¡××š
      const doc = await this._createDocument(printSettings);
      
      // ×”×•×¡×¤×ª ×©×¢×¨ (×× ×¦×¨×™×š)
      if (printSettings.addCover) {
        await this._addCoverPage(doc, collection, printSettings);
      }
      
      // ×”×•×¡×¤×ª ×”×§×“×©×” (×× ×¦×¨×™×š)
      if (printSettings.addDedication && printSettings.dedicationText) {
        await this._addDedicationPage(doc, printSettings);
      }
      
      // ×”×•×¡×¤×ª ×ª×•×›×Ÿ ×”×¤×¨×™×˜×™×
      for (const item of collection.items) {
        await this._addItemToDocument(doc, item, printSettings);
      }
      
      // ×”×¤×§×ª ×”×§×•×‘×¥
      const pdfBlob = await doc.output('blob');
      
      return pdfBlob;
    } catch (error) {
      console.error('Error generating PDF:', error);
      throw new Error('Failed to generate PDF');
    }
  }
  
  /**
   * ×™×¦×™×¨×ª ××¡××š ×—×“×©
   * @private
   */
  async _createDocument(settings) {
    // ×›××Ÿ × ×™×™×¦×¨ ××¡××š PDF ×—×“×© ×¢× ×”×’×“×¨×•×ª ×”×“×£
    console.log('Creating new document with format:', settings.format);
    return {}; // ×¤×•× ×§×¦×™×” ×œ×“×•×’××”
  }
  
  /**
   * ×”×•×¡×¤×ª ×¢××•×“ ×©×¢×¨
   * @private
   */
  async _addCoverPage(doc, collection, settings) {
    console.log('Adding cover page for collection:', collection.title);
    return doc; // ×¤×•× ×§×¦×™×” ×œ×“×•×’××”
  }
  
  /**
   * ×”×•×¡×¤×ª ×¢××•×“ ×”×§×“×©×”
   * @private
   */
  async _addDedicationPage(doc, settings) {
    console.log('Adding dedication page with text:', settings.dedicationText);
    return doc; // ×¤×•× ×§×¦×™×” ×œ×“×•×’××”
  }
  
  /**
   * ×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ××¡××š
   * @private
   */
  async _addItemToDocument(doc, item, settings) {
    // ×§×‘×œ×ª ×”×ª×•×›×Ÿ ×”××¢×•×“×›×Ÿ ×©×œ ×”×¤×¨×™×˜
    const content = item.getEditedContent();
    
    // ×”×•×¡×¤×ª ×”×›×•×ª×¨×ª ×•×”×ª×•×›×Ÿ ×œ×¤×™ ×¡×•×’ ×”×¤×¨×™×˜
    console.log('Adding item to document, type:', item.type);
    
    return doc; // ×¤×•× ×§×¦×™×” ×œ×“×•×’××”
  }
  
  /**
   * ×”×“×¤×¡×” ×™×©×™×¨×” ×œ××“×¤×¡×ª
   * @param {Blob} pdfBlob - ×§×•×‘×¥ PDF ×œ×”×“×¤×¡×”
   */
  async printDirect(pdfBlob) {
    try {
      // ×™×¦×™×¨×ª URL ×œ×§×•×‘×¥
      const pdfUrl = URL.createObjectURL(pdfBlob);
      
      // ×¤×ª×™×—×ª ×—×œ×•×Ÿ ×”×“×¤×¡×”
      const printWindow = window.open(pdfUrl);
      
      printWindow.addEventListener('load', function() {
        printWindow.print();
        // ×©×—×¨×•×¨ ×”-URL ×œ××—×¨ ×”×”×“×¤×¡×”
        setTimeout(function() {
          printWindow.close();
          URL.revokeObjectURL(pdfUrl);
        }, 1000);
      });
    } catch (error) {
      console.error('Error printing document:', error);
      throw new Error('Failed to print document');
    }
  }
}

// ============================================
// ×××©×§ ×¤×¨×•× ×˜× ×“ ×œ×× ×”×œ ×”×ª×•×›×Ÿ ×”××™×©×™
// ============================================

/**
 * ××—×œ×§×” ×”××§×©×¨×ª ×‘×™×Ÿ ×××©×§ ×”××©×ª××© ×œ×× ×”×œ ×”×ª×•×›×Ÿ
 */
class PersonalAreaViewController {
  constructor(contentManager, printManager) {
    this.contentManager = contentManager;
    this.printManager = printManager;
    this.currentCollection = null;
    this.currentUser = null;
    this.printSettings = { ...this.printManager.defaultSettings };
  }
  
  /**
   * ××ª×—×•×œ ×”×‘×§×¨ ×œ××—×¨ ×˜×¢×™× ×ª ×”×“×£
   */
  async initialize(userId) {
    try {
      this.currentUser = userId;
      
      // ×˜×¢×™× ×ª ×”×××¨×–×™× ×©×œ ×”××©×ª××©
      const collections = await this.contentManager.getUserCollections(userId);
      
      // ×”×¦×’×ª ×”×××¨×–×™× ×‘×××©×§
      this.renderCollectionsList(collections);
      
      // ×”×’×“×¨×ª ×××–×™× ×™ ××™×¨×•×¢×™×
      this.setupEventListeners();
    } catch (error) {
      console.error('Error initializing personal area:', error);
      this.showErrorMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××–×•×¨ ×”××™×©×™');
    }
  }
  
  /**
   * ×”×’×“×¨×ª ×××–×™× ×™ ××™×¨×•×¢×™×
   */
  setupEventListeners() {
    // ×××–×™× ×™ ××™×¨×•×¢×™× ×œ×˜××‘×™×
    document.querySelectorAll('.tab').forEach((tab, index) => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        this.switchTab(index);
      });
    });
    
    // ×›×¤×ª×•×¨ ×™×¦×™×¨×ª ×××¨×– ×—×“×©
    document.getElementById('new-collection-btn').addEventListener('click', () => {
      this.showNewCollectionModal();
    });
    
    // ×›×¤×ª×•×¨×™ ×”×“×¤×¡×”
    document.getElementById('download-pdf-btn').addEventListener('click', () => {
      this.downloadCurrentCollectionAsPDF();
    });
    
    document.getElementById('print-now-btn').addEventListener('click', () => {
      this.printCurrentCollection();
    });
  }
  
  /**
   * ××¢×‘×¨ ×‘×™×Ÿ ×˜××‘×™×
   * @param {number} tabIndex - ××™× ×“×§×¡ ×”×˜××‘
   */
  switchTab(tabIndex) {
    // ×”×¡×¨×ª ×§×œ××¡ '×¤×¢×™×œ' ××›×œ ×”×˜××‘×™×
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // ×”×•×¡×¤×ª ×§×œ××¡ '×¤×¢×™×œ' ×œ×˜××‘ ×”× ×‘×—×¨
    document.querySelectorAll('.tab')[tabIndex].classList.add('active');
    
    // ×”×¡×ª×¨×ª ×›×œ ×ª×•×›×Ÿ ×”×˜××‘×™×
    document.querySelectorAll('.tab-content').forEach(content => {
      content.style.display = 'none';
    });
    
    // ×”×¦×’×ª ×”×ª×•×›×Ÿ ×©×œ ×”×˜××‘ ×”× ×‘×—×¨
    document.querySelectorAll('.tab-content')[tabIndex].style.display = 'block';
  }
  
  /**
   * ×”×¦×’×ª ×”×××¨×–×™× ×‘×¨×©×™××”
   * @param {Array} collections - ×××¨×–×™× ×œ×”×¦×’×”
   */
  renderCollectionsList(collections) {
    const container = document.querySelector('.collections-grid');
    container.innerHTML = '';
    
    collections.forEach(collection => {
      const itemElement = document.createElement('a');
      itemElement.href = '#';
      itemElement.className = 'collection-item';
      itemElement.setAttribute('data-id', collection.id);
      
      let iconClass = 'ğŸ“–'; // ×‘×¨×™×¨×ª ××—×“×œ
      if (collection.type === 'prayers') iconClass = 'ğŸ™';
      else if (collection.type === 'edited') iconClass = 'ğŸ“';
      
      itemElement.innerHTML = `
        <div class="collection-icon">${iconClass}</div>
        <div class="collection-title">${collection.title}</div>
        <div class="collection-info">
          ${collection.items.length} ×¤×¨×™×˜×™× â€¢ ×¢×•×“×›×Ÿ ${this.formatDate(collection.lastModified)}
        </div>
      `;
      
      // ×××–×™×Ÿ ×œ×—×™×¦×”
      itemElement.addEventListener('click', (e) => {
        e.preventDefault();
        this.loadCollection(collection.id);
      });
      
      container.appendChild(itemElement);
    });
  }
  
  /**
   * ×˜×¢×™× ×ª ×××¨×–
   * @param {string} collectionId - ××–×”×” ×”×××¨×–
   */
  async loadCollection(collectionId) {
    try {
      const collection = await this.contentManager.loadCollection(collectionId);
      this.currentCollection = collection;
      
      // ×”×¦×’×ª ×”×××¨×– ×‘×××©×§ ×”×¢×¨×™×›×”
      this.renderCollectionContent(collection);
      
      // ××¢×‘×¨ ×œ×˜××‘ ×”×¢×¨×™×›×”
      this.switchTab(1);
    } catch (error) {
      console.error(`Error loading collection ${collectionId}:`, error);
      this.showErrorMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×××¨×–');
    }
  }
  
  /**
   * ×”×¦×’×ª ×ª×•×›×Ÿ ×”×××¨×– ×‘×××©×§ ×”×¢×¨×™×›×”
   * @param {PersonalCollection} collection - ×”×××¨×– ×œ×”×¦×’×”
   */
  renderCollectionContent(collection) {
    // ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª
    document.querySelector('#edit .card-title').textContent = collection.title;
    
    // ×”×¦×’×ª ×”×¤×¨×™×˜×™×
    const itemsContainer = document.querySelector('#edit .card-body');
    itemsContainer.innerHTML = '';
    
    collection.items.forEach(item => {
      // ×”×¦×’×ª ×”×ª×•×›×Ÿ ×”××ª×•×§×Ÿ
      const content = item.getEditedContent();
      
      const itemElement = document.createElement('div');
      itemElement.className = 'edited-content';
      itemElement.innerHTML = content;
      
      // ×›×¤×ª×•×¨×™ ×¢×¨×™×›×”
      const editOverlay = document.createElement('div');
      editOverlay.className = 'edit-overlay';
      editOverlay.innerHTML = `
        <button class="edit-btn" data-id="${item.id}">âœï¸</button>
        <button class="edit-btn" data-id="${item.id}">â•</button>
      `;
      
      itemElement.appendChild(editOverlay);
      itemsContainer.appendChild(itemElement);
      
      // ×××–×™× ×™ ×¢×¨×™×›×”
      editOverlay.querySelector('button:first-child').addEventListener('click', () => {
        this.showEditItemModal(item);
      });
    });
    
    // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×”×“×¤×¡×”
    this.updatePrintSettings();
  }
  
  /**
   * ×”×¦×’×ª ×—×œ×•×Ÿ ×™×¦×™×¨×ª ×××¨×– ×—×“×©
   */
  showNewCollectionModal() {
    // ×›××Ÿ × ×™×¦×•×¨ ×•× ×¦×™×’ ××•×“×œ ×œ×™×¦×™×¨×ª ×××¨×– ×—×“×©
    // ×‘××™××•×© ××œ×, × ×¦×™×’ ××•×“×œ HTML ×¢× ×˜×•×¤×¡
    
    const title = prompt('×©× ×”×××¨×– ×”×—×“×©:');
    const type = prompt('×¡×•×’ ×”×××¨×– (tehilim/prayers/edited):');
    
    if (title && type) {
      this.createNewCollection(title, type);
    }
  }
  
  /**
   * ×™×¦×™×¨×ª ×××¨×– ×—×“×©
   */
  async createNewCollection(title, type) {
    try {
      const newCollection = await this.contentManager.createCollection(
        this.currentUser,
        title,
        type
      );
      
      // ×”×•×¡×¤×ª ×”×××¨×– ×”×—×“×© ×œ×¨×©×™××”
      const collections = await this.contentManager.getUserCollections(this.currentUser);
      this.renderCollectionsList(collections);
      
      // ××¢×‘×¨ ×œ×××¨×– ×”×—×“×©
      this.loadCollection(newCollection.id);
    } catch (error) {
      console.error('Error creating new collection:', error);
      this.showErrorMessage('×©×’×™××” ×‘×™×¦×™×¨×ª ×××¨×– ×—×“×©');
    }
  }
  
  /**
   * ×”×¦×’×ª ×—×œ×•×Ÿ ×¢×¨×™×›×ª ×¤×¨×™×˜
   * @param {CollectionItem} item - ×”×¤×¨×™×˜ ×œ×¢×¨×™×›×”
   */
  showEditItemModal(item) {
    // ×›××Ÿ × ×™×¦×•×¨ ×•× ×¦×™×’ ××•×“×œ ×œ×¢×¨×™×›×ª ×¤×¨×™×˜
    // ×‘××™××•×© ××œ×, × ×¦×™×’ ××•×“×œ HTML ×¢× ××¤×©×¨×•×™×•×ª ×”×¢×¨×™×›×”
    
    const content = prompt('×¢×¨×•×š ××ª ×”×ª×•×›×Ÿ:', item.content);
    
    if (content) {
      // ×œ×“×•×’××” ×‘×œ×‘×“ - ×‘×¤×•×¢×œ × ×©×ª××© ×‘×××©×§ ×”×¢×¨×™×›×” ×”××ª×§×“×
      const positions = [{start: 0, end: 10}]; // ×œ×“×•×’××”
      this.editItem(this.currentCollection.id, item.id, 'divine-name', '×”\'', positions);
    }
  }
  
  /**
   * ×¢×¨×™×›×ª ×¤×¨×™×˜
   */
  async editItem(collectionId, itemId, editType, replacementStyle, positions) {
    try {
      await this.contentManager.editCollectionItem(
        collectionId,
        itemId,
        editType,
        replacementStyle,
        positions
      );
      
      // ×¨×¢× ×•×Ÿ ×ª×¦×•×’×ª ×”×××¨×–
      this.loadCollection(collectionId);
    } catch (error) {
      console.error('Error editing item:', error);
      this.showErrorMessage('×©×’×™××” ×‘×¢×¨×™×›×ª ×”×¤×¨×™×˜');
    }
  }
  
  /**
   * ×¢×“×›×•×Ÿ ×”×’×“×¨×•×ª ×”×“×¤×¡×”
   */
  updatePrintSettings() {
    if (!this.currentCollection) return;
    
    const container = document.querySelector('#print .card-body');
    
    // ×¢×“×›×•×Ÿ ×©× ×”×××¨×–
    document.querySelector('#print .card-title').textContent = 
      `×”×“×¤×¡×ª "${this.currentCollection.title}"`;
    
    // ×”×¦×’×ª ×”×’×“×¨×•×ª ×”×“×¤×¡×” × ×•×›×—×™×•×ª
    document.querySelectorAll('.setting-value').forEach(setting => {
      const key = setting.closest('.setting-row').querySelector('div:first-child').textContent;
      
      // ×”×ª×××ª ×”×¢×¨×›×™× ×œ××” ×©××•×¦×’ ×‘×××©×§
      switch (key) {
        case '×’×•×“×œ ×’×•×¤×Ÿ':
          setting.textContent = this.getFontSizeText(this.printSettings.fontSizeHebrew);
          break;
        case '×¡×’× ×•×Ÿ ×©× ×”×³':
          setting.textContent = this.printSettings.divineNameStyle;
          break;
        case '×”×•×¡×£ × ×™×§×•×“':
          setting.textContent = this.printSettings.showNikkud ? '×›×Ÿ' : '×œ×';
          break;
        case '×ª×¦×•×’×ª ×˜×§×¡×˜':
          setting.textContent = this.printSettings.showBothLanguages ? '×¢×‘×¨×™×ª + ×¨×•×¡×™×ª' : '×¢×‘×¨×™×ª ×‘×œ×‘×“';
          break;
      }
    });
  }
  
  /**
   * ×”×•×¨×“×ª ×”×××¨×– ×”× ×•×›×—×™ ×›-PDF
   */
  async downloadCurrentCollectionAsPDF() {
    if (!this.currentCollection) {
      this.showErrorMessage('×™×© ×œ×‘×—×•×¨ ×××¨×– ×œ×”×“×¤×¡×”');
      return;
    }
    
    try {
      const pdfBlob = await this.printManager.generatePDF(
        this.currentCollection,
        this.printSettings
      );
      
      // ×™×¦×™×¨×ª ×§×™×©×•×¨ ×”×•×¨×“×”
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${this.currentCollection.title}.pdf`;
      a.click();
      
      // ×©×—×¨×•×¨ ×”-URL
      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 100);
    } catch (error) {
      console.error('Error downloading PDF:', error);
      this.showErrorMessage('×©×’×™××” ×‘×™×¦×™×¨×ª ×§×•×‘×¥ PDF');
    }
  }
  
  /**
   * ×”×“×¤×¡×ª ×”×××¨×– ×”× ×•×›×—×™
   */
  async printCurrentCollection() {
    if (!this.currentCollection) {
      this.showErrorMessage('×™×© ×œ×‘×—×•×¨ ×××¨×– ×œ×”×“×¤×¡×”');
      return;
    }
    
    try {
      const pdfBlob = await this.printManager.generatePDF(
        this.currentCollection,
        this.printSettings
      );
      
      await this.printManager.printDirect(pdfBlob);
    } catch (error) {
      console.error('Error printing collection:', error);
      this.showErrorMessage('×©×’×™××” ×‘×”×“×¤×¡×”');
    }
  }
  
  /**
   * ×¤×•×¨××˜ ×ª××¨×™×š
   * @param {Date} date - ×”×ª××¨×™×š
   * @returns {string} ×”×ª×